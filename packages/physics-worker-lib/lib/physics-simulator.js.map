{"version":3,"file":"physics-simulator.js","sourceRoot":"","sources":["../src/physics-simulator.ts"],"names":[],"mappings":"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","sourcesContent":["import { BodyDescriptor, ObjectStateTree, ObjectType, WorldDescriptor } from '@hydraengine/shared'\nimport { PhysicsObject } from './physics-node/physics-object'\nimport { PhysicsWorld } from './physics-node/physics-world'\n\nexport class PhysicsSimulator {\n  readonly #stateTree: ObjectStateTree\n  readonly #worldDescriptors: Record<number, WorldDescriptor>\n  readonly #bodyDescriptors: Record<number, BodyDescriptor>\n\n  #worlds = new Map<number, PhysicsWorld>()\n  #objects = new Map<number, PhysicsObject>()\n  #simulationStep = 0\n\n  constructor(\n    readonly stateTree: ObjectStateTree,\n    readonly worldDescriptors: Record<number, WorldDescriptor>,\n    readonly bodyDescriptors: Record<number, BodyDescriptor>,\n  ) {\n    this.#stateTree = stateTree\n    this.#worldDescriptors = worldDescriptors\n    this.#bodyDescriptors = bodyDescriptors\n  }\n\n  update(dt: number) {\n    const dts = dt * 1000\n    const matterDt = dts > 16.666 ? 16.666 : dts\n    this.#worlds.forEach((world) => world.update(matterDt))\n\n    const step = ++this.#simulationStep\n    const tree = this.#stateTree\n    tree.forEach((id) => {\n      const objectType = tree.getObjectType(id)\n\n      if (objectType === ObjectType.PhysicsWorld) {\n        let world = this.#worlds.get(id)\n        if (!world) {\n          world = new PhysicsWorld(this.#worldDescriptors[id]?.gravity ?? 0)\n          this.#worlds.set(id, world)\n        }\n        world.processedStep = step\n      }\n\n      if (objectType === ObjectType.PhysicsObject) {\n        let object = this.#objects.get(id)\n        if (!object) {\n          const bodyId = tree.getBodyId(id)\n          const bd = this.#bodyDescriptors[bodyId]\n          object = new PhysicsObject(bd.width, bd.height, bd.fixedRotation, bd.isStatic)\n          this.#objects.set(id, object)\n        }\n\n        if (!object.world) {\n          object.world = this.#worlds.get(tree.getParent(id))\n        }\n\n        object.processedStep = step\n      }\n    })\n\n    for (const [id, world] of this.#worlds) {\n      if (world.processedStep !== step) {\n        this.#worlds.delete(id)\n      }\n    }\n\n    for (const [id, object] of this.#objects) {\n      if (object.processedStep !== step) {\n        this.#objects.delete(id)\n      }\n    }\n  }\n}\n"]}