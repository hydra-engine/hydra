{"version":3,"file":"renderer.js","sourceRoot":"","sources":["../src/renderer.ts"],"names":[],"mappings":"AAAA,OAAO,EAAmB,OAAO,EAAE,MAAM,qBAAqB,CAAA;AAC9D,OAAO,EAAqB,SAAS,EAAE,UAAU,EAA4B,gBAAgB,EAAE,kBAAkB,EAAE,MAAM,SAAS,CAAA;AAElI,UAAU,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAA;AAChC,MAAM,SAAS,GAAG,MAAM,CAAC,UAAU,CAAC,CAAA;AAEpC,MAAM,OAAO,QAAQ;IAWR;IACA;IACA;IAZF,gBAAgB,CAAiB;IACjC,iBAAiB,CAAQ;IACzB,UAAU,CAAiB;IAEpC,aAAa,CAAe;IAC5B,KAAK,GAAG,IAAI,SAAS,CAAC,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,CAAA;IACjD,WAAW,GAAG,IAAI,GAAG,EAAqB,CAAA;IAC1C,WAAW,GAAG,CAAC,CAAA;IAEf,YACW,eAAgC,EAChC,gBAAwB,EACxB,SAA0B;QAF1B,oBAAe,GAAf,eAAe,CAAiB;QAChC,qBAAgB,GAAhB,gBAAgB,CAAQ;QACxB,cAAS,GAAT,SAAS,CAAiB;QAEnC,IAAI,CAAC,gBAAgB,GAAG,eAAe,CAAA;QACvC,IAAI,CAAC,iBAAiB,GAAG,gBAAgB,CAAA;QACzC,IAAI,CAAC,UAAU,GAAG,SAAS,CAAA;QAC3B,IAAI,CAAC,KAAK,EAAE,CAAA;IACd,CAAC;IAED,KAAK,CAAC,KAAK;QACT,MAAM,OAAO,GAA+B;YAC1C,MAAM,EAAE,IAAI,CAAC,gBAAgB;YAC7B,SAAS,EAAE,MAAM;YACjB,UAAU,EAAE,IAAI,CAAC,iBAAiB;SACnC,CAAA;QAED,IAAI,CAAC,aAAa,GAAG,MAAM,kBAAkB,CAAC,OAAO,CAAC,CAAA;IACxD,CAAC;IAED,MAAM;QACJ,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAA;QACnC,IAAI,CAAC,QAAQ;YAAE,OAAM;QAErB,MAAM,IAAI,GAAG,EAAE,IAAI,CAAC,WAAW,CAAA;QAC/B,IAAI,MAAM,GAAG,CAAC,CAAA;QAEd,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,EAAE,EAAE,EAAE;YAC7B,IAAI,EAAE,KAAK,OAAO;gBAAE,OAAM;YAE1B,IAAI,SAAS,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,CAAC,CAAA;YACxC,IAAI,CAAC,SAAS,EAAE,CAAC;gBACf,SAAS,GAAG,IAAI,SAAS,EAAE,CAAA;gBAC3B,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,EAAE,SAAS,CAAC,CAAA;gBACnC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAA;YAChC,CAAC;YAED,SAAS,CAAC,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAA;YACtC,SAAS,CAAC,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAA;YAEtC,SAAS,CAAC,MAAM,GAAG,MAAM,EAAE,CAAA;YAC1B,SAAiB,CAAC,SAAS,CAAC,GAAG,IAAI,CAAA;QACtC,CAAC,CAAC,CAAA;QAEF,KAAK,MAAM,CAAC,EAAE,EAAE,SAAS,CAAC,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YAC/C,IAAK,SAAiB,CAAC,SAAS,CAAC,KAAK,IAAI,EAAE,CAAC;gBAC3C,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,SAAS,CAAC,CAAA;gBACjC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,EAAE,CAAC,CAAA;YAC7B,CAAC;QACH,CAAC;QAED,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;IAC7B,CAAC;CACF","sourcesContent":["import { ObjectStateTree, ROOT_ID } from '@hydraengine/shared'\nimport { AutoDetectOptions, Container, DOMAdapter, Renderer as PixiRenderer, WebWorkerAdapter, autoDetectRenderer } from 'pixi.js'\n\nDOMAdapter.set(WebWorkerAdapter)\nconst SEEN_PASS = Symbol('seenPass')\n\nexport class Renderer {\n  readonly #offscreenCanvas: OffscreenCanvas\n  readonly #devicePixelRatio: number\n  readonly #stateTree: ObjectStateTree\n\n  #pixiRenderer?: PixiRenderer\n  #root = new Container({ sortableChildren: true })\n  #containers = new Map<number, Container>()\n  #renderPass = 0\n\n  constructor(\n    readonly offscreenCanvas: OffscreenCanvas,\n    readonly devicePixelRatio: number,\n    readonly stateTree: ObjectStateTree\n  ) {\n    this.#offscreenCanvas = offscreenCanvas\n    this.#devicePixelRatio = devicePixelRatio\n    this.#stateTree = stateTree\n    this.#init()\n  }\n\n  async #init() {\n    const options: Partial<AutoDetectOptions> = {\n      canvas: this.#offscreenCanvas,\n      eventMode: 'none',\n      resolution: this.#devicePixelRatio,\n    }\n\n    this.#pixiRenderer = await autoDetectRenderer(options)\n  }\n\n  render() {\n    const renderer = this.#pixiRenderer\n    if (!renderer) return\n\n    const pass = ++this.#renderPass\n    let zIndex = 0\n\n    this.#stateTree.forEach((id) => {\n      if (id === ROOT_ID) return\n\n      let container = this.#containers.get(id)\n      if (!container) {\n        container = new Container()\n        this.#containers.set(id, container)\n        this.#root.addChild(container)\n      }\n\n      container.x = this.#stateTree.getX(id)\n      container.y = this.#stateTree.getY(id)\n\n      container.zIndex = zIndex++\n      (container as any)[SEEN_PASS] = pass\n    })\n\n    for (const [id, container] of this.#containers) {\n      if ((container as any)[SEEN_PASS] !== pass) {\n        this.#root.removeChild(container)\n        this.#containers.delete(id)\n      }\n    }\n\n    renderer.render(this.#root)\n  }\n}\n"]}