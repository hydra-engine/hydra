{"version":3,"file":"game-object.js","sourceRoot":"","sources":["../../../src/logic-node/core/game-object.ts"],"names":[],"mappings":"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","sourcesContent":["import { ObjectStateTree, ObjectType } from '@hydraengine/shared'\nimport { EventMap } from '@webtaku/event-emitter'\nimport { MessageBridge } from '../../message-bridge'\nimport { GameNode } from './game-node'\nimport { LocalTransform } from './local-transform'\nimport { WorldTransform } from './world-transform'\n\nexport function isGameObject(v: unknown): v is GameObject {\n  return (v as any).attachToStateTree !== undefined\n}\n\nexport type GameObjectOptions = {\n  x?: number\n  y?: number\n  scale?: number\n  scaleX?: number\n  scaleY?: number\n  pivotX?: number\n  pivotY?: number\n  rotation?: number\n\n  alpha?: number\n  layer?: number\n  useYSort?: boolean\n}\n\nexport class GameObject<E extends EventMap = EventMap> extends GameNode<E> {\n  protected id?: number\n  protected stateTree?: ObjectStateTree\n  protected messageBridge?: MessageBridge\n\n  type = ObjectType.GameObject\n  #localTransform = new LocalTransform()\n  worldTransform = new WorldTransform()\n  alpha = 1\n  #layer = 0\n  #tint = 0xffffff\n\n  #drawOrder?: number\n  #drawOrderDirty = false\n  #useYSort = false\n\n  constructor(options?: GameObjectOptions) {\n    super()\n    if (options) {\n      if (options.x !== undefined) this.x = options.x\n      if (options.y !== undefined) this.y = options.y\n      if (options.scale !== undefined) this.scale = options.scale\n      if (options.scaleX !== undefined) this.scaleX = options.scaleX\n      if (options.scaleY !== undefined) this.scaleY = options.scaleY\n      if (options.pivotX !== undefined) this.pivotX = options.pivotX\n      if (options.pivotY !== undefined) this.pivotY = options.pivotY\n      if (options.rotation !== undefined) this.rotation = options.rotation\n      if (options.alpha !== undefined) this.alpha = options.alpha\n      if (options.layer !== undefined) this.layer = options.layer\n      if (options.useYSort !== undefined) this.#useYSort = options.useYSort\n    }\n  }\n\n  protected attachToStateTree(parentId: number, stateTree: ObjectStateTree, messageBridge: MessageBridge) {\n    this.#detachFromStateTree()\n\n    const id = stateTree.newChild(parentId)\n    stateTree.setObjectType(id, this.type)\n    stateTree.setLayer(id, this.#layer)\n    stateTree.setTint(id, this.#tint + 1)\n\n    this.id = id\n    this.stateTree = stateTree\n    this.messageBridge = messageBridge\n\n    this.#localTransform.setStateTree(id, stateTree)\n    this.worldTransform.setStateTree(id, stateTree)\n    stateTree.setLocalAlpha(id, this.alpha)\n\n    for (const child of this.children) {\n      if (isGameObject(child)) {\n        child.attachToStateTree(id, stateTree, messageBridge)\n      }\n    }\n\n    return id\n  }\n\n  #detachFromStateTree() {\n    if (this.id !== undefined && this.stateTree) this.stateTree.remove(this.id)\n    this.id = undefined\n    this.stateTree = undefined\n    this.#localTransform.clearStateTree()\n    this.worldTransform.clearStateTree()\n  }\n\n  override add(...children: GameNode<EventMap>[]) {\n    super.add(...children)\n\n    if (this.id !== undefined && this.stateTree && this.messageBridge) {\n      for (const child of children) {\n        if (isGameObject(child)) {\n          child.attachToStateTree(this.id, this.stateTree, this.messageBridge)\n        }\n      }\n    }\n  }\n\n  override update(dt: number) {\n    if (this.paused) return\n\n    super.update(dt)\n\n    if (this.#useYSort) {\n      this.drawOrder = this.y\n    }\n\n    let childOrderDirty = false\n    for (const child of this.children) {\n      if (this.id !== undefined && this.stateTree && isGameObject(child) && child.#drawOrderDirty) {\n        childOrderDirty = true\n        child.#drawOrderDirty = false\n      }\n    }\n\n    if (childOrderDirty && this.id !== undefined && this.stateTree) {\n      this.stateTree.sortChildren(this.id)\n    }\n  }\n\n  override remove() {\n    this.#detachFromStateTree()\n    super.remove()\n  }\n\n  set x(v) { this.#localTransform.x = v }\n  get x() { return this.#localTransform.x }\n\n  set y(v) { this.#localTransform.y = v }\n  get y() { return this.#localTransform.y }\n\n  set scale(v) { this.#localTransform.scaleX = v; this.#localTransform.scaleY = v }\n  get scale() { return this.#localTransform.scaleX }\n\n  set scaleX(v) { this.#localTransform.scaleX = v }\n  get scaleX() { return this.#localTransform.scaleX }\n\n  set scaleY(v) { this.#localTransform.scaleY = v }\n  get scaleY() { return this.#localTransform.scaleY }\n\n  set pivotX(v) { this.#localTransform.pivotX = v }\n  get pivotX() { return this.#localTransform.pivotX }\n\n  set pivotY(v) { this.#localTransform.pivotY = v }\n  get pivotY() { return this.#localTransform.pivotY }\n\n  set rotation(v) { this.#localTransform.rotation = v }\n  get rotation() { return this.#localTransform.rotation }\n\n  set layer(v) {\n    if (!isNaN(v) && this.#layer !== v) {\n      this.#layer = v\n\n      if (this.id !== undefined && this.stateTree) {\n        this.stateTree.setLayer(this.id, v)\n      }\n    }\n  }\n  get layer() { return this.#layer }\n\n  set tint(v) {\n    if (!isNaN(v) && this.#tint !== v) {\n      this.#tint = v\n\n      if (this.id !== undefined && this.stateTree) {\n        this.stateTree.setTint(this.id, v + 1)\n      }\n    }\n  }\n  get tint() { return this.#tint }\n\n  set drawOrder(v) {\n    if (!isNaN(v) && this.#drawOrder !== v) {\n      this.#drawOrder = v\n      this.#drawOrderDirty = true\n\n      if (this.id !== undefined && this.stateTree) {\n        this.stateTree.setDrawOrder(this.id, v)\n      }\n    }\n  }\n  get drawOrder() { return this.#drawOrder ?? 0 }\n}\n"]}