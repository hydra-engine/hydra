{"version":3,"file":"preloader.js","sourceRoot":"","sources":["../src/preloader.ts"],"names":[],"mappings":"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","sourcesContent":["import { AssetSource } from '@hydraengine/shared'\nimport { audioLoader } from './loaders/audio'\nimport { fontFamilyLoader } from './loaders/font'\nimport { Loader } from './loaders/loader'\n\nconst EXTERNAL_LOADER = Symbol('EXTERNAL_LOADER')\n\nconst loaderForPathMap: Array<{ check: (path: string) => boolean, loader: Loader<any> | typeof EXTERNAL_LOADER }> = [\n  { check: (p) => p.endsWith('.json') || p.endsWith('.atlas'), loader: EXTERNAL_LOADER }, // 외부 주입\n  { check: (p) => p.endsWith('.skel'), loader: EXTERNAL_LOADER }, // 외부 주입\n  { check: (p) => /\\.(png|jpe?g|gif|webp)$/i.test(p), loader: EXTERNAL_LOADER }, // 외부 주입\n  { check: (p) => /\\.(mp3|wav|ogg)$/i.test(p), loader: audioLoader },\n  { check: (p) => !p.includes('.'), loader: fontFamilyLoader }\n]\n\nfunction getLoaderForPath(path: string): Loader<any> | typeof EXTERNAL_LOADER | undefined {\n  return loaderForPathMap.find(({ check }) => check(path))?.loader\n}\n\nconst idToLoaderMap = new Map<number, Loader<any> | typeof EXTERNAL_LOADER>()\n\nasync function loadAsset(id: number, asset: AssetSource): Promise<void> {\n  if (typeof asset === 'string') {\n    const loader = getLoaderForPath(asset)\n    if (!loader) {\n      console.warn(`No loader found for asset: ${asset}`)\n      return\n    }\n    idToLoaderMap.set(id, loader)\n    if (loader !== EXTERNAL_LOADER) {\n      await loader.load(id, asset)\n    }\n  } else {\n    console.warn(`Unknown asset type: ${asset}`)\n  }\n}\n\nfunction releaseAsset(id: number): void {\n  const loader = idToLoaderMap.get(id)\n  if (!loader) {\n    console.warn(`No loader found for asset ID: ${id}`)\n    return\n  }\n  if (loader !== EXTERNAL_LOADER) {\n    loader.release(id)\n  }\n}\n\nexport class Preloader {\n  #assetSources: Record<number, AssetSource>\n  #assetIds: number[]\n  #targets: number[]                 // 내부 로더가 있는 id만\n  #progressCallback?: (progress: number) => void\n  #loadedCount = 0\n  #loadedSet = new Set<number>()\n  #resolvePreload?: () => void\n  #preloadPromise: Promise<void>\n\n  constructor(\n    assetSources: Record<number, AssetSource>,\n    assetIds: number[],\n    progressCallback?: (progress: number) => void,\n  ) {\n    this.#assetSources = assetSources\n    this.#assetIds = assetIds\n    this.#progressCallback = progressCallback\n\n    // 프리로드 대상: EXTERNAL_LOADER(외부 주입) 제외\n    this.#targets = this.#assetIds.filter((id) => {\n      const src = this.#assetSources[id]\n      if (typeof src !== 'string') return false\n      const loader = getLoaderForPath(src)\n      return !!loader && loader !== EXTERNAL_LOADER\n    })\n\n    this.#preloadPromise = new Promise<void>((resolve) => {\n      this.#resolvePreload = resolve\n    })\n  }\n\n  /** loadAsset을 사용해 실제 프리로드 수행 */\n  async preload(): Promise<void> {\n    // 대상이 없거나 이미 완료된 경우 즉시 resolve\n    if (this.#targets.length === 0 || this.#loadedCount >= this.#targets.length) {\n      this.#resolvePreload?.()\n      return this.#preloadPromise\n    }\n\n    await Promise.all(\n      this.#targets.map(async (id) => {\n        const asset = this.#assetSources[id]\n        if (asset === undefined) {\n          console.warn(`[Preloader] Missing asset for id=${id}`)\n          // 진행률 계산의 일관성을 위해 missing도 mark\n          this.markLoaded(id)\n          return\n        }\n        try {\n          await loadAsset(id, asset)\n        } catch (e) {\n          console.warn(`[Preloader] Failed to load asset (id=${id}):`, e)\n        } finally {\n          this.markLoaded(id)\n        }\n      })\n    )\n\n    return this.#preloadPromise\n  }\n\n  /** 진행률 업데이트 (내부 로더 대상만 카운트) */\n  markLoaded(id: number) {\n    if (!this.#targets.includes(id)) return // 대상 외 id 무시\n    if (this.#loadedSet.has(id)) return     // 중복 로딩 방지\n\n    this.#loadedSet.add(id)\n    this.#loadedCount++\n\n    const progress = this.#loadedCount / this.#targets.length\n    this.#progressCallback?.(progress)\n\n    if (this.#loadedCount === this.#targets.length) {\n      this.#resolvePreload?.()\n    }\n  }\n\n  /** 프리로드된(내부 로더 대상) 리소스 해제 */\n  release(): void {\n    for (const id of this.#targets) {\n      if (this.#loadedSet.has(id)) {\n        try {\n          releaseAsset(id)\n        } catch (e) {\n          console.warn(`[Preloader] Failed to release asset (id=${id}):`, e)\n        }\n      }\n    }\n  }\n}\n"]}