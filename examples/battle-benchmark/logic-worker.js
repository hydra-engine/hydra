(()=>{"use strict";const t=new class{play(t){postMessage({type:"playMusic",asset:t})}pause(){postMessage({type:"pauseMusic"})}stop(){postMessage({type:"stopMusic"})}},e=new class{play(t){postMessage({type:"playSfx",asset:t})}playRandom(...t){this.play(t[Math.floor(Math.random()*t.length)])}};var s;!function(t){t[t.Rectangle=0]="Rectangle",t[t.Circle=1]="Circle",t[t.Ellipse=2]="Ellipse",t[t.Polygon=3]="Polygon"}(s||(s={}));const i=t=>t<0?-t:t;function r(t){return"number"==typeof t&&Number.isFinite(t)}function a(...t){for(let e=0;e<t.length;e++)if(!r(t[e]))return!1;return!0}function o(t){return a(t.x,t.y,t.cos,t.sin,t.scaleX,t.scaleY,t.rotation)}function h(t){return a(t.width,t.height,t.x??0,t.y??0)}function n(t){return a(t.radius,t.x??0,t.y??0)}function c(t){return a(t.width,t.height,t.x??0,t.y??0)}function l(t){if(!Array.isArray(t.vertices)||0===t.vertices.length)return!1;for(let e=0;e<t.vertices.length;e++){const s=t.vertices[e];if(!a(s?.x,s?.y))return!1}return a(t.x??0,t.y??0)}function d(t,e,s,i,r,o,h,n){if(!a(t,e,s,i,r,o,h,n))return NaN;const c=t*s+e*i,l=t*r+e*o;return h*(c<0?-c:c)+n*(l<0?-l:l)}function u(t,e,s,i,r,o,h,n,c,l,u,p,g,f,y,_){if(!a(t,e,s,i,r,o,h,n,c,l,u,p,g,f,y,_))return!0;const m=s*t+i*e,T=m<0?-m:m,S=d(t,e,r,o,h,n,c,l),v=d(t,e,u,p,g,f,y,_);return!a(T,S,v)||T>S+v}let p=0,g=0;function f(t,e){if(!o(e)||!n(t))return p=NaN,void(g=NaN);const s=e.scaleX,i=e.scaleY,r=e.cos,a=e.sin,h=r,c=a,l=-a,d=r,u=(t.x||0)*s,f=(t.y||0)*i;p=e.x+h*u+l*f,g=e.y+c*u+d*f}function y(t,e){if(!o(e)||!n(t))return NaN;const s=i(e.scaleX),r=i(e.scaleY);return t.radius*(s>r?s:r)}function _(t,e,s,r){if(!(o(e)&&o(r)&&h(t)&&n(s)))return!1;const c=e.scaleX,l=e.scaleY,d=.5*i(t.width*c),u=.5*i(t.height*l),_=e.cos,m=e.sin,T=_,S=m,v=-m,R=_,X=(t.x||0)*c,x=(t.y||0)*l,O=e.x+T*X+v*x,I=e.y+S*X+R*x;if(!a(d,u,T,S,v,R,O,I))return!1;f(s,r);const E=y(s,r);if(!a(p,g,E))return!1;const F=p-O,Y=g-I;if(!a(F,Y))return!1;const H=F*T+Y*S,w=F*v+Y*R;if(!a(H,w))return!1;const b=H-(H<-d?-d:H>d?d:H),C=w-(w<-u?-u:w>u?u:w);return!!a(b,C)&&b*b+C*C<=E*E}function m(t,e,s,i){if(!(o(e)&&o(i)&&l(t)&&n(s)))return!1;const h=t.vertices,c=h.length;if(0===c)return!1;const d=e.scaleX,u=e.scaleY,_=e.cos,m=e.sin,T=_,S=m,v=-m,R=_,X=(t.x||0)*d,x=(t.y||0)*u,O=e.x+T*X+v*x,I=e.y+S*X+R*x;if(!a(d,u,T,S,v,R,O,I))return!1;f(s,i);const E=p,F=g,Y=y(s,i);if(!a(E,F,Y))return!1;let H=0,w=0,b=0;for(H=0;H<c;H++){w=(H+1)%c;const t=h[w].x-h[H].x,e=h[w].y-h[H].y,s=-(S*(d*t)+R*(u*e)),i=T*(d*t)+v*(u*e);if(!a(s,i))return!1;const o=(s*T+i*S)*d,n=(s*v+i*R)*u,l=s*O+i*I;if(!a(o,n,l))return!1;let p=1/0,g=-1/0;for(b=0;b<c;b++){const t=l+o*h[b].x+n*h[b].y;if(!r(t))return!1;t<p&&(p=t),t>g&&(g=t)}const f=Math.hypot(s,i);if(!r(f))return!1;const y=s*E+i*F;if(!r(y))return!1;const _=y-Y*f,m=y+Y*f;if(!a(_,m))return!1;if(g<_||m<p)return!1}let C=0,P=0,A=1/0;for(H=0;H<c;H++){const t=O+T*(d*h[H].x)+v*(u*h[H].y),e=I+S*(d*h[H].x)+R*(u*h[H].y);if(!a(t,e))return!1;const s=E-t,i=F-e;if(!a(s,i))return!1;const o=s*s+i*i;if(!r(o))return!1;o<A&&(A=o,C=s,P=i)}if(!r(A))return!1;if(0===A)return!0;{const t=C,e=P;if(!a(t,e))return!1;const s=(t*T+e*S)*d,i=(t*v+e*R)*u,o=t*O+e*I;if(!a(s,i,o))return!1;let n=1/0,l=-1/0;for(H=0;H<c;H++){const t=o+s*h[H].x+i*h[H].y;if(!r(t))return!1;t<n&&(n=t),t>l&&(l=t)}const p=Math.hypot(t,e);if(!r(p))return!1;const g=t*E+e*F;if(!r(g))return!1;const f=g-Y*p,y=g+Y*p;if(!a(f,y))return!1;if(l<f||y<n)return!1}return!0}function T(t,e,s,n){if(!(o(e)&&o(n)&&l(t)&&h(s)))return!1;const c=t.vertices,d=c.length;if(0===d)return!1;const u=e.scaleX,p=e.scaleY,g=e.cos,f=e.sin,y=g,_=f,m=-f,T=g,S=(t.x||0)*u,v=(t.y||0)*p,R=e.x+y*S+m*v,X=e.y+_*S+T*v;if(!a(u,p,y,_,m,T,R,X))return!1;const x=n.scaleX,O=n.scaleY,I=.5*i(s.width*x),E=.5*i(s.height*O),F=n.cos,Y=n.sin,H=F,w=Y,b=-Y,C=F,P=(s.x||0)*x,A=(s.y||0)*O,B=n.x+H*P+b*A,N=n.y+w*P+C*A;if(!a(I,E,H,w,b,C,B,N))return!1;let L=0,M=0,D=0;for(L=0;L<d;L++){M=(L+1)%d;const t=c[M].x-c[L].x,e=c[M].y-c[L].y,s=-(_*(u*t)+T*(p*e)),i=y*(u*t)+m*(p*e);if(!a(s,i))return!1;const o=(s*y+i*_)*u,h=(s*m+i*T)*p,n=s*R+i*X;if(!a(o,h,n))return!1;let l=1/0,g=-1/0;for(D=0;D<d;D++){const t=n+o*c[D].x+h*c[D].y;if(!r(t))return!1;t<l&&(l=t),t>g&&(g=t)}const f=s*H+i*w,S=s*b+i*C;if(!a(f,S))return!1;const v=I*(f<0?-f:f)+E*(S<0?-S:S),x=s*B+i*N;if(!a(v,x))return!1;const O=x-v,F=x+v;if(!a(O,F))return!1;if(g<O||F<l)return!1}{const t=H,e=w,s=(t*y+e*_)*u,i=(t*m+e*T)*p,o=t*R+e*X;if(!a(t,e,s,i,o))return!1;let h=1/0,n=-1/0;for(L=0;L<d;L++){const t=o+s*c[L].x+i*c[L].y;if(!r(t))return!1;t<h&&(h=t),t>n&&(n=t)}const l=t*B+e*N;if(!r(l))return!1;const g=l-I,f=l+I;if(!a(g,f))return!1;if(n<g||f<h)return!1}{const t=b,e=C,s=(t*y+e*_)*u,i=(t*m+e*T)*p,o=t*R+e*X;if(!a(t,e,s,i,o))return!1;let h=1/0,n=-1/0;for(L=0;L<d;L++){const t=o+s*c[L].x+i*c[L].y;if(!r(t))return!1;t<h&&(h=t),t>n&&(n=t)}const l=t*B+e*N;if(!r(l))return!1;const g=l-E,f=l+E;if(!a(g,f))return!1;if(n<g||f<h)return!1}return!0}let S=0,v=0;var R;!function(t){t[t.None=0]="None",t[t.Ellipse=1]="Ellipse",t[t.OBB=2]="OBB",t[t.Circle=3]="Circle",t[t.Poly=4]="Poly",t[t.PolyLocal=5]="PolyLocal"}(R||(R={}));let X=0,x=0,O=0,I=0,E=0,F=0,Y=0,H=0,w=0,b=0,C=null,P=0,A=0,B=0,N=0,L=0,M=0,D=0,k=0,U=0,W=0,G=0,V=null;function q(t,e,s,i,a){const o=Math.hypot(t,e);if(!r(o))return S=NaN,void(v=NaN);if(0===o)return S=s,void(v=i);const h=1/o;S=s+t*h*a,v=i+e*h*a}function j(t,e,s,i,r,o,h,n,c,l){if(!a(t,e,s,i,r,o,h,n,c,l))return S=NaN,void(v=NaN);const d=t*r+e*o>=0?1:-1,u=t*h+e*n>=0?1:-1;S=s+r*c*d+h*l*u,v=i+o*c*d+n*l*u}function $(t,e){return t*e}function z(t,e,s,i,o,h,n,c,l,d){if(!a(t,e,s,i,o,h,n,c,l,d))return S=NaN,void(v=NaN);const u=t*o+$(e,h),p=t*n+$(e,c),g=Math.hypot(l*u,d*p);if(!r(g))return S=NaN,void(v=NaN);if(0===g)return S=s,void(v=i);const f=l*l*u/g,y=d*d*p/g;S=s+f*o+y*n,v=i+f*h+y*c}function J(t,e,s){if(!a(t,e))return S=NaN,void(v=NaN);let i=0,o=-1/0;for(let a=0,h=s.length;a<h;a++){const h=t*s[a].x+e*s[a].y;if(!r(h))return S=NaN,void(v=NaN);h>o&&(o=h,i=a)}S=s[i].x,v=s[i].y}function K(t,e,s,i,o,h,n,c,l,d,u){if(!a(t,e,i,o,h,n,c,l,d,u))return S=NaN,void(v=NaN);const p=(t*h+e*n)*d,g=(t*c+e*l)*u;if(!a(p,g))return S=NaN,void(v=NaN);let f=0,y=-1/0;for(let t=0,e=s.length;t<e;t++){const e=p*s[t].x+g*s[t].y;if(!r(e))return S=NaN,void(v=NaN);e>y&&(y=e,f=t)}const _=s[f].x,m=s[f].y;S=i+h*(d*_)+c*(u*m),v=o+n*(d*_)+l*(u*m)}function Q(){const t=1e-18;let e=0,s=0,i=0,o=0,h=0,n=0,c=0,l=1,d=0;function u(){!function(t,e){1===X?z(t,e,O,I,E,F,Y,H,w,b):2===X?j(t,e,O,I,E,F,Y,H,0,0):3===X?q(t,e,O,I,0):4===X?J(t,e,C):5===X?K(t,e,C,O,I,E,F,Y,H,w,b):(S=NaN,v=NaN)}(l,d);const t=S,r=v;!function(t,e){1===x?z(t,e,P,A,B,N,L,M,D,k):2===x?j(t,e,P,A,B,N,L,M,U,W):3===x?q(t,e,P,A,G):4===x?J(t,e,V):5===x?K(t,e,V,P,A,B,N,L,M,D,k):(S=NaN,v=NaN)}(-l,-d);const u=S,p=v;a(t,r,u,p)?(h=i,n=o,i=e,o=s,e=t-u,s=r-p,c<3&&c++):e=s=i=o=h=n=NaN}if(u(),!a(e,s))return!1;if(e*e+s*s<=t)return!0;l=-e,d=-s;for(let p=0;p<32;p++){const p=l*l+d*d;if(!r(p))return!1;if(p<=t)return!0;if(u(),!a(e,s,i,o,h,n))return!1;const g=e*l+s*d;if(!r(g))return!1;if(g<=0)return!1;if(e*e+s*s<=t)return!0;if(2===c){const t=i-e,r=o-s,h=-e,n=-s,c=t*t+r*r,u=h*t+n*r;if(!a(t,r,h,n,c,u))return!1;l=h*c-t*u,d=n*c-r*u;continue}const f=i-e,y=o-s,_=h-e,m=n-s,T=-e,S=-s;if(!a(f,y,_,m,T,S))return!1;const v=_*f+m*y,R=T*f+S*y;let X=T*v-_*R,x=S*v-m*R;if(!a(v,R,X,x))return!1;if(X*T+x*S>0){h=i,n=o,c=2,l=X,d=x;continue}const O=f*_+y*m,I=T*_+S*m;let E=T*O-f*I,F=S*O-y*I;if(!a(O,I,E,F))return!1;if(!(E*T+F*S>0))return!0;i=h,o=n,c=2,l=E,d=F}return!1}function Z(t,e,s,r){if(!(o(e)&&o(r)&&c(t)&&h(s)))return!1;const n=e.scaleX,l=e.scaleY;w=.5*i(t.width*n),b=.5*i(t.height*l);const d=e.cos,u=e.sin;E=d,F=u,Y=-u,H=d;const p=(t.x||0)*n,g=(t.y||0)*l;O=e.x+E*p+Y*g,I=e.y+F*p+H*g,X=1,C=null;const f=r.scaleX,y=r.scaleY;U=.5*i(s.width*f),W=.5*i(s.height*y);const _=r.cos,m=r.sin;B=_,N=m,L=-m,M=_;const T=(s.x||0)*f,S=(s.y||0)*y;return P=r.x+B*T+L*S,A=r.y+N*T+M*S,x=2,V=null,!!a(w,b,E,F,Y,H,O,I,U,W,B,N,L,M,P,A)&&Q()}function tt(t,e,s,r){if(!(o(e)&&o(r)&&c(t)&&n(s)))return!1;const h=e.scaleX,l=e.scaleY;w=.5*i(t.width*h),b=.5*i(t.height*l);const d=e.cos,u=e.sin;E=d,F=u,Y=-u,H=d;const _=(t.x||0)*h,m=(t.y||0)*l;return O=e.x+E*_+Y*m,I=e.y+F*_+H*m,X=1,C=null,f(s,r),P=p,A=g,G=y(s,r),x=3,V=null,!!a(w,b,E,F,Y,H,O,I,P,A,G)&&Q()}function et(t,e,s,r){if(!(o(e)&&o(r)&&l(t)&&c(s)))return!1;const h=e.scaleX,n=e.scaleY,d=e.cos,u=e.sin,p=d,g=u,f=-u,y=d,_=(t.x||0)*h,m=(t.y||0)*n;O=e.x+p*_+f*m,I=e.y+g*_+y*m,E=p,F=g,Y=f,H=y,w=h,b=n,C=t.vertices,X=5;const T=r.scaleX,S=r.scaleY;D=.5*i(s.width*T),k=.5*i(s.height*S);const v=r.cos,R=r.sin;B=v,N=R,L=-R,M=v;const U=(s.x||0)*T,W=(s.y||0)*S;return P=r.x+B*U+L*W,A=r.y+N*U+M*W,V=null,x=1,!!a(O,I,E,F,Y,H,w,b,P,A,B,N,L,M,D,k)&&Q()}function st(t,e,d,S){return!(!o(e)||!o(S))&&(t.type===s.Rectangle&&d.type===s.Rectangle?function(t,e,s,r){if(!(o(e)&&o(r)&&h(t)&&h(s)))return!1;const n=e.scaleX,c=e.scaleY,l=.5*i(t.width*n),d=.5*i(t.height*c),p=e.cos,g=e.sin,f=p,y=g,_=-g,m=p,T=(t.x||0)*n,S=(t.y||0)*c,v=e.x+f*T+_*S,R=e.y+y*T+m*S,X=r.scaleX,x=r.scaleY,O=.5*i(s.width*X),I=.5*i(s.height*x),E=r.cos,F=r.sin,Y=E,H=F,w=-F,b=E,C=(s.x||0)*X,P=(s.y||0)*x,A=r.x+Y*C+w*P,B=r.y+H*C+b*P;if(!a(l,d,O,I,v,R,A,B,f,y,_,m,Y,H,w,b))return!1;const N=e.rotation,L=r.rotation;if(!(0!==N&&0!==N||0!==L&&0!==L)){const t=A-v,e=t<0?-t:t,s=B-R,i=s<0?-s:s;return!!a(e,i)&&e<=l+O&&i<=d+I}const M=A-v,D=B-R;return!(!a(M,D)||u(f,y,M,D,f,y,_,m,l,d,Y,H,w,b,O,I)||u(_,m,M,D,f,y,_,m,l,d,Y,H,w,b,O,I)||u(Y,H,M,D,f,y,_,m,l,d,Y,H,w,b,O,I)||u(w,b,M,D,f,y,_,m,l,d,Y,H,w,b,O,I))}(t,e,d,S):t.type===s.Circle&&d.type===s.Circle?function(t,e,s,i){if(!(o(e)&&o(i)&&n(t)&&n(s)))return!1;f(t,e);const r=p,h=g;f(s,i);const c=p,l=g,d=y(t,e),u=y(s,i);if(!a(r,h,c,l,d,u))return!1;const _=c-r,m=l-h,T=d+u;return _*_+m*m<=T*T}(t,e,d,S):t.type===s.Rectangle&&d.type===s.Circle?_(t,e,d,S):t.type===s.Circle&&d.type===s.Rectangle?_(d,S,t,e):t.type===s.Polygon&&d.type===s.Polygon?function(t,e,s,i){if(!(o(e)&&o(i)&&l(t)&&l(s)))return!1;const h=t.vertices,n=s.vertices,c=h.length,d=n.length;if(0===c||0===d)return!1;const u=e.scaleX,p=e.scaleY,g=e.cos,f=e.sin,y=g,_=f,m=-f,T=g,S=(t.x||0)*u,v=(t.y||0)*p,R=e.x+y*S+m*v,X=e.y+_*S+T*v,x=i.scaleX,O=i.scaleY,I=i.cos,E=i.sin,F=I,Y=E,H=-E,w=I,b=(s.x||0)*x,C=(s.y||0)*O,P=i.x+F*b+H*C,A=i.y+Y*b+w*C;if(!a(u,p,y,_,m,T,R,X,x,O,F,Y,H,w,P,A))return!1;let B=0,N=0,L=0;for(B=0;B<c;B++){N=(B+1)%c;const t=h[N].x-h[B].x,e=h[N].y-h[B].y,s=-(_*(u*t)+T*(p*e)),i=y*(u*t)+m*(p*e);if(!a(s,i))return!1;const o=(s*y+i*_)*u,l=(s*m+i*T)*p,g=s*R+i*X;if(!a(o,l,g))return!1;let f=1/0,S=-1/0;for(L=0;L<c;L++){const t=g+o*h[L].x+l*h[L].y;if(!r(t))return!1;t<f&&(f=t),t>S&&(S=t)}const v=(s*F+i*Y)*x,I=(s*H+i*w)*O,E=s*P+i*A;if(!a(v,I,E))return!1;let b=1/0,C=-1/0;for(L=0;L<d;L++){const t=E+v*n[L].x+I*n[L].y;if(!r(t))return!1;t<b&&(b=t),t>C&&(C=t)}if(S<b||C<f)return!1}for(B=0;B<d;B++){N=(B+1)%d;const t=n[N].x-n[B].x,e=n[N].y-n[B].y,s=-(Y*(x*t)+w*(O*e)),i=F*(x*t)+H*(O*e);if(!a(s,i))return!1;const o=(s*y+i*_)*u,l=(s*m+i*T)*p,g=s*R+i*X;if(!a(o,l,g))return!1;let f=1/0,S=-1/0;for(L=0;L<c;L++){const t=g+o*h[L].x+l*h[L].y;if(!r(t))return!1;t<f&&(f=t),t>S&&(S=t)}const v=(s*F+i*Y)*x,I=(s*H+i*w)*O,E=s*P+i*A;if(!a(v,I,E))return!1;let b=1/0,C=-1/0;for(L=0;L<d;L++){const t=E+v*n[L].x+I*n[L].y;if(!r(t))return!1;t<b&&(b=t),t>C&&(C=t)}if(S<b||C<f)return!1}return!0}(t,e,d,S):t.type===s.Polygon&&d.type===s.Circle?m(t,e,d,S):t.type===s.Circle&&d.type===s.Polygon?m(d,S,t,e):t.type===s.Polygon&&d.type===s.Rectangle?T(t,e,d,S):t.type===s.Rectangle&&d.type===s.Polygon?T(d,S,t,e):t.type===s.Ellipse&&d.type===s.Rectangle?Z(t,e,d,S):t.type===s.Rectangle&&d.type===s.Ellipse?Z(d,S,t,e):t.type===s.Ellipse&&d.type===s.Circle?tt(t,e,d,S):t.type===s.Circle&&d.type===s.Ellipse?tt(d,S,t,e):t.type===s.Ellipse&&d.type===s.Ellipse?function(t,e,s,r){if(!(o(e)&&o(r)&&c(t)&&c(s)))return!1;const h=e.scaleX,n=e.scaleY;w=.5*i(t.width*h),b=.5*i(t.height*n);const l=e.cos,d=e.sin;E=l,F=d,Y=-d,H=l;const u=(t.x||0)*h,p=(t.y||0)*n;O=e.x+E*u+Y*p,I=e.y+F*u+H*p,X=1,C=null;const g=r.scaleX,f=r.scaleY;D=.5*i(s.width*g),k=.5*i(s.height*f);const y=r.cos,_=r.sin;B=y,N=_,L=-_,M=y;const m=(s.x||0)*g,T=(s.y||0)*f;return P=r.x+B*m+L*T,A=r.y+N*m+M*T,x=1,V=null,!!a(w,b,E,F,Y,H,O,I,D,k,B,N,L,M,P,A)&&Q()}(t,e,d,S):t.type===s.Polygon&&d.type===s.Ellipse?et(t,e,d,S):t.type===s.Ellipse&&d.type===s.Polygon&&et(d,S,t,e))}const it=4294967295;let rt=!1;class at{#t;#e;constructor(t,e,s,i){this.#e=s;const r=s*i,a=Math.ceil(r/32);this.#t=new Uint32Array(t,e,a)}static bytesRequired(t,e){const s=t*e;return Math.ceil(s/32)*Uint32Array.BYTES_PER_ELEMENT}get byteLength(){return this.#t.byteLength}#s(t,e){return t*this.#e+e}set(t,e,s){const i=this.#s(t,e),r=i>>>5,a=1<<(31&i);s?this.#t[r]|=a:this.#t[r]&=~a}get(t,e){const s=this.#s(t,e),i=s>>>5,r=1<<(31&s);return 0!==(this.#t[i]&r)}}class ot{#i;#e;constructor(t,e,s,i){this.#e=s,this.#i=new Float32Array(t,e,s*i)}static bytesRequired(t,e){return t*e*Float32Array.BYTES_PER_ELEMENT}get byteLength(){return this.#i.byteLength}#r(t){return t*this.#e}set(t,e,s){this.#i[this.#r(t)+e]=s}get(t,e){return this.#i[this.#r(t)+e]}}class ht{#i;#e;constructor(t,e,s,i){this.#e=s,this.#i=new Uint32Array(t,e,s*i)}static bytesRequired(t,e){return t*e*Uint32Array.BYTES_PER_ELEMENT}get byteLength(){return this.#i.byteLength}#r(t){return t*this.#e}set(t,e,s){this.#i[this.#r(t)+e]=s}get(t,e){return this.#i[this.#r(t)+e]}}class nt{#a;constructor(t,e,s){this.#a=new Uint32Array(t,e,5*s)}static bytesRequired(t){return 5*t*Uint32Array.BYTES_PER_ELEMENT}get byteLength(){return this.#a.byteLength}#r(t){return 5*t}parent(t){return this.#a[this.#r(t)+0]}#o(t){return this.#a[this.#r(t)+1]}#h(t){return this.#a[this.#r(t)+2]}#n(t){return this.#a[this.#r(t)+4]}remove(t){const e=this.#r(t),s=this.#a[e+0],i=this.#a[e+3],r=this.#a[e+4];if(s!==it){const e=this.#r(s);this.#a[e+1]===t&&(this.#a[e+1]=r),this.#a[e+2]===t&&(this.#a[e+2]=i)}i!==it&&(this.#a[this.#r(i)+4]=r),r!==it&&(this.#a[this.#r(r)+3]=i)}#c(t,e){const s=this.#r(t),i=this.#r(e);this.#a[i+0]=t,this.#a[i+3]=it,this.#a[i+4]=it,this.#a[s+1]=e,this.#a[s+2]=e}#l(t,e,s){const i=this.#r(e),r=this.#a[i+4],a=this.#r(s);this.#a[a+0]=t,this.#a[a+3]=e,this.#a[a+4]=r,this.#a[i+4]=s,r!==it?this.#a[this.#r(r)+3]=s:this.#a[this.#r(t)+2]=s}#d(t,e,s){const i=this.#r(e),r=this.#a[i+3],a=this.#r(s);this.#a[a+0]=t,this.#a[a+4]=e,this.#a[a+3]=r,this.#a[i+3]=s,r!==it?this.#a[this.#r(r)+4]=s:this.#a[this.#r(t)+1]=s}insert(t,e){this.remove(e);const s=this.#h(t);s===it?this.#c(t,e):this.#l(t,s,e)}insertAt(t,e,s){this.remove(e);const i=this.#o(t);if(i===it)return void this.#c(t,e);if(s<=0)return void this.#d(t,i,e);let r=0,a=i;for(;a!==it&&r<s;)a=this.#n(a),r++;a===it?this.insert(t,e):this.#d(t,a,e)}forEach(t){let e=0;for(;;){t(e);const s=this.#o(e);if(s===it)for(;;){if(0===e)return;const t=this.#n(e);if(t!==it){e=t;break}e=this.parent(e)}else e=s}}sortChildren(t,e){let s=this.#o(t);if(s===it||this.#n(s)===it)return;const i=[];let r=s;for(;r!==it;)i.push(r),r=this.#n(r);i.sort((t,s)=>e(t)-e(s));const a=this.#r(t);this.#a[a+1]=i[0],this.#a[a+2]=i[i.length-1];for(let e=0;e<i.length;e++){const s=i[e],r=this.#r(s),a=e>0?i[e-1]:it,o=e<i.length-1?i[e+1]:it;this.#a[r+0]=t,this.#a[r+3]=a,this.#a[r+4]=o}}}class ct{#u;#i;#p;constructor(t,e,s){this.#u=new Uint32Array(t,e,2),this.#i=new Uint32Array(t,e+2*Uint32Array.BYTES_PER_ELEMENT,s),this.#p=s}static bytesRequired(t){return(2+t)*Uint32Array.BYTES_PER_ELEMENT}get byteLength(){return this.#u.byteLength+this.#i.byteLength}enqueue(t){const e=this.#u[1];this.#i[e]=t,this.#u[1]=(e+1)%this.#p}dequeue(){const t=this.#u[0];return this.#u[0]=(t+1)%this.#p,this.#i[t]}}class lt{#g;constructor(t,e,s){this.#g=new ct(t,e,s-1)}static bytesRequired(t){return ct.bytesRequired(t-1)}get byteLength(){return this.#g.byteLength}alloc(){return this.#g.dequeue()}free(t){this.#g.enqueue(t)}}class dt{#f;#y;#_;#m;#T;constructor(t,e,s,i,r){this.#f=new lt(t,0,r);let a=this.#f.byteLength;this.#y=new nt(t,a,r),a+=this.#y.byteLength,this.#_=new at(t,a,e,r),a+=this.#_.byteLength,this.#m=new ht(t,a,s,r),a+=this.#m.byteLength,this.#T=new ot(t,a,i,r)}static bytesRequired(t,e,s,i){return lt.bytesRequired(i)+nt.bytesRequired(i)+at.bytesRequired(t,i)+ht.bytesRequired(e,i)+ot.bytesRequired(s,i)}newChild(t){const e=this.#f.alloc();return this.#y.insert(t,e),e}getParent(t){return this.#y.parent(t)}insertAt(t,e,s){this.#y.insertAt(t,e,s)}remove(t){this.#y.remove(t),this.#f.free(t)}setBoolean(t,e,s){this.#_.set(t,e,s)}getBoolean(t,e){return this.#_.get(t,e)}setUint32(t,e,s){this.#m.set(t,e,s)}getUint32(t,e){return this.#m.get(t,e)}setFloat32(t,e,s){this.#T.set(t,e,s)}getFloat32(t,e){return this.#T.get(t,e)}forEach(t){this.#y.forEach(t)}sortChildren(t,e){this.#y.sortChildren(t,e)}}const ut=1e6;class pt extends dt{constructor(t){super(t,0,5,23,ut)}static bytesRequired(){return dt.bytesRequired(0,5,23,ut)}setObjectType(t,e){this.setUint32(t,0,e)}getObjectType(t){return this.getUint32(t,0)}setLocalX(t,e){this.setFloat32(t,1,e)}getLocalX(t){return this.getFloat32(t,1)}setLocalY(t,e){this.setFloat32(t,2,e)}getLocalY(t){return this.getFloat32(t,2)}setLocalScaleX(t,e){this.setFloat32(t,3,e)}getLocalScaleX(t){return this.getFloat32(t,3)}setLocalScaleY(t,e){this.setFloat32(t,4,e)}getLocalScaleY(t){return this.getFloat32(t,4)}setLocalPivotX(t,e){this.setFloat32(t,5,e)}getLocalPivotX(t){return this.getFloat32(t,5)}setLocalPivotY(t,e){this.setFloat32(t,6,e)}getLocalPivotY(t){return this.getFloat32(t,6)}setLocalRotation(t,e){this.setFloat32(t,7,e)}getLocalRotation(t){return this.getFloat32(t,7)}setLocalCos(t,e){this.setFloat32(t,8,e)}getLocalCos(t){return this.getFloat32(t,8)}setLocalSin(t,e){this.setFloat32(t,9,e)}getLocalSin(t){return this.getFloat32(t,9)}setLocalAlpha(t,e){this.setFloat32(t,10,e)}getLocalAlpha(t){return this.getFloat32(t,10)}setWorldX(t,e){this.setFloat32(t,11,e)}getWorldX(t){return this.getFloat32(t,11)}setWorldY(t,e){this.setFloat32(t,12,e)}getWorldY(t){return this.getFloat32(t,12)}setWorldScaleX(t,e){this.setFloat32(t,13,e)}getWorldScaleX(t){return this.getFloat32(t,13)}setWorldScaleY(t,e){this.setFloat32(t,14,e)}getWorldScaleY(t){return this.getFloat32(t,14)}setWorldRotation(t,e){this.setFloat32(t,15,e)}getWorldRotation(t){return this.getFloat32(t,15)}setWorldCos(t,e){this.setFloat32(t,16,e)}getWorldCos(t){return this.getFloat32(t,16)}setWorldSin(t,e){this.setFloat32(t,17,e)}getWorldSin(t){return this.getFloat32(t,17)}setWorldAlpha(t,e){this.setFloat32(t,18,e)}getWorldAlpha(t){return this.getFloat32(t,18)}setLayer(t,e){this.setUint32(t,1,e)}getLayer(t){return this.getUint32(t,1)}setDrawOrder(t,e){this.setFloat32(t,0,e)}getDrawOrder(t){return this.getFloat32(t,0)}setTint(t,e){this.setUint32(t,2,e)}getTint(t){return this.getUint32(t,2)}setAssetId(t,e){this.setUint32(t,3,e)}getAssetId(t){return this.getUint32(t,3)}setAnimationId(t,e){this.setUint32(t,4,e)}getAnimationId(t){return this.getUint32(t,4)}setShapeId(t,e){this.setUint32(t,3,e)}getShapeId(t){return this.getUint32(t,3)}setRadius(t,e){this.setFloat32(t,19,e)}getRadius(t){return this.getFloat32(t,19)}setWidth(t,e){this.setFloat32(t,19,e)}getWidth(t){return this.getFloat32(t,19)}setHeight(t,e){this.setFloat32(t,20,e)}getHeight(t){return this.getFloat32(t,20)}setWorldId(t,e){this.setUint32(t,3,e)}getWorldId(t){return this.getUint32(t,3)}setBodyId(t,e){this.setUint32(t,3,e)}getBodyId(t){return this.getUint32(t,3)}setVelocityX(t,e){this.setFloat32(t,19,e)}getVelocityX(t){return this.getFloat32(t,19)}setVelocityY(t,e){this.setFloat32(t,20,e)}getVelocityY(t){return this.getFloat32(t,20)}setTargetX(t,e){this.setFloat32(t,21,e)}getTargetX(t){return this.getFloat32(t,21)}setTargetY(t,e){this.setFloat32(t,22,e)}getTargetY(t){return this.getFloat32(t,22)}#S=t=>this.getDrawOrder(t);sortChildren(t){super.sortChildren(t,this.#S)}}var gt,ft;!function(t){t[t.GameObject=0]="GameObject",t[t.Sprite=1]="Sprite",t[t.AnimatedSprite=2]="AnimatedSprite",t[t.Rectangle=3]="Rectangle",t[t.Circle=4]="Circle",t[t.BitmapText=5]="BitmapText",t[t.PhysicsWorld=6]="PhysicsWorld",t[t.PhysicsObject=7]="PhysicsObject"}(gt||(gt={}));class yt{#v;#R=0;constructor(t,e){this.#v=void 0!==e&&e>0?e:void 0;let s=performance.now(),i=0;const r=e=>{const a=(e-s)/1e3;if(a>0){const r=this.#v;if(void 0!==r&&r>0){i+=a;const e=1/r;i>=e&&(t(e),i>=2*e?(t(a),i=0):i-=e)}else t(a);s=e}this.#R=requestAnimationFrame(r)};this.#R=requestAnimationFrame(r)}setFpsCap(t){this.#v=t>0?t:void 0}disableFpsCap(){this.#v=void 0}remove(){cancelAnimationFrame(this.#R)}}!function(t){t[t.Rectangle=0]="Rectangle",t[t.Circle=1]="Circle",t[t.Polygon=2]="Polygon"}(ft||(ft={}));class _t{#X={};on(t,e){return this.#X[t]||(this.#X[t]=[]),this.#X[t].push({listener:e}),this}once(t,e){return this.#X[t]||(this.#X[t]=[]),this.#X[t].push({listener:e,once:!0}),this}off(t,e){const s=this.#X[t];return s?(this.#X[t]=s.filter(t=>t.listener!==e),0===this.#X[t].length&&delete this.#X[t],this):this}async emit(t,...e){const s=this.#X[t];if(!s)return[];const i=[],r=[];for(const a of s){const s=a.listener(...e);a.once&&this.off(t,a.listener),s instanceof Promise?r.push(s):i.push(s)}return i.concat(await Promise.all(r))}#x=[];bindTo(t,e,s){this.on(e,s);const i=()=>{this.off(e,s);const i=this.#x.findIndex(i=>i.target===t&&i.key===e&&i.listener===s);-1!==i&&this.#x.splice(i,1)};return t.on("remove",i),this.#x.push({key:e,target:t,listener:s,removeHandler:i}),this}remove(){this.emit("remove");for(const t of this.#x)t.target.off("remove",t.removeHandler);this.#x.length=0}}class mt extends _t{#O;children=[];paused=!1;set parent(t){this.#O=t}get parent(){return this.#O}add(...t){for(const e of t){if(e.#O){const t=e.#O.children.indexOf(e);-1!==t&&e.#O.children.splice(t,1)}e.parent=this,this.children.push(e)}}remove(){if(super.remove(),this.#O){const t=this.#O.children.indexOf(this);-1!==t&&this.#O.children.splice(t,1),this.#O=void 0}for(const t of this.children)t.parent=void 0,t.remove();this.children.length=0}pause(){this.paused=!0;for(const t of this.children)t.pause()}resume(){this.paused=!1;for(const t of this.children)t.resume()}update(t){if(!this.paused){for(const e of this.children)e.paused||e.update(t);this.emit("update",t)}}}class Tt{#I;#E;#F=0;#Y=0;#H=1;#w=1;#b=0;#C=0;#P=0;#A=1;#B=0;get x(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalX(t):this.#F}set x(t){if(this.x!==t){this.#F=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalX(e,t)}}get y(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalY(t):this.#Y}set y(t){if(this.y!==t){this.#Y=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalY(e,t)}}get scaleX(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalScaleX(t):this.#H}set scaleX(t){if(this.scaleX!==t){this.#H=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalScaleX(e,t)}}get scaleY(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalScaleY(t):this.#w}set scaleY(t){if(this.scaleY!==t){this.#w=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalScaleY(e,t)}}get pivotX(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalPivotX(t):this.#b}set pivotX(t){if(this.pivotX!==t){this.#b=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalPivotX(e,t)}}get pivotY(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalPivotY(t):this.#C}set pivotY(t){if(this.pivotY!==t){this.#C=t;const e=this.#I,s=this.#E;s&&void 0!==e&&s.setLocalPivotY(e,t)}}get rotation(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getLocalRotation(t):this.#P}set rotation(t){if(this.rotation!==t){this.#P=t;const e=Math.cos(t),s=Math.sin(t);this.#A=e,this.#B=s;const i=this.#I,r=this.#E;r&&void 0!==i&&(r.setLocalRotation(i,t),r.setLocalCos(i,e),r.setLocalSin(i,s))}}setStateTree(t,e){this.#I=t,this.#E=e,e.setLocalX(t,this.#F),e.setLocalY(t,this.#Y),e.setLocalScaleX(t,this.#H),e.setLocalScaleY(t,this.#w),e.setLocalPivotX(t,this.#b),e.setLocalPivotY(t,this.#C),e.setLocalRotation(t,this.#P),e.setLocalCos(t,this.#A),e.setLocalSin(t,this.#B)}clearStateTree(){this.#I=void 0,this.#E=void 0}}class St{#I;#E;get x(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldX(t):NaN}get y(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldY(t):NaN}get scaleX(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldScaleX(t):1}get scaleY(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldScaleY(t):1}get rotation(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldRotation(t):0}get cos(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldCos(t):1}get sin(){const t=this.#I,e=this.#E;return e&&void 0!==t?e.getWorldSin(t):0}setStateTree(t,e){this.#I=t,this.#E=e}clearStateTree(){this.#I=void 0,this.#E=void 0}}function vt(t){return void 0!==t.attachToStateTree}class Rt extends mt{id;stateTree;messageBridge;type=gt.GameObject;#N=new Tt;worldTransform=new St;alpha=1;#L=0;#M=16777215;#D;#k=!1;#U=!1;constructor(t){super(),t&&(void 0!==t.x&&(this.x=t.x),void 0!==t.y&&(this.y=t.y),void 0!==t.scale&&(this.scale=t.scale),void 0!==t.scaleX&&(this.scaleX=t.scaleX),void 0!==t.scaleY&&(this.scaleY=t.scaleY),void 0!==t.pivotX&&(this.pivotX=t.pivotX),void 0!==t.pivotY&&(this.pivotY=t.pivotY),void 0!==t.rotation&&(this.rotation=t.rotation),void 0!==t.alpha&&(this.alpha=t.alpha),void 0!==t.layer&&(this.layer=t.layer),void 0!==t.useYSort&&(this.#U=t.useYSort))}attachToStateTree(t,e,s){this.#W();const i=e.newChild(t);e.setObjectType(i,this.type),e.setLayer(i,this.#L),e.setTint(i,this.#M+1),this.id=i,this.stateTree=e,this.messageBridge=s,this.#N.setStateTree(i,e),this.worldTransform.setStateTree(i,e),e.setLocalAlpha(i,this.alpha);for(const t of this.children)vt(t)&&t.attachToStateTree(i,e,s);return i}#W(){void 0!==this.id&&this.stateTree&&this.stateTree.remove(this.id),this.id=void 0,this.stateTree=void 0,this.#N.clearStateTree(),this.worldTransform.clearStateTree()}add(...t){if(super.add(...t),void 0!==this.id&&this.stateTree&&this.messageBridge)for(const e of t)vt(e)&&e.attachToStateTree(this.id,this.stateTree,this.messageBridge)}update(t){if(this.paused)return;super.update(t),this.#U&&(this.drawOrder=this.y);let e=!1;for(const t of this.children)void 0!==this.id&&this.stateTree&&vt(t)&&t.#k&&(e=!0,t.#k=!1);e&&void 0!==this.id&&this.stateTree&&this.stateTree.sortChildren(this.id)}remove(){this.#W(),super.remove()}set x(t){this.#N.x=t}get x(){return this.#N.x}set y(t){this.#N.y=t}get y(){return this.#N.y}set scale(t){this.#N.scaleX=t,this.#N.scaleY=t}get scale(){return this.#N.scaleX}set scaleX(t){this.#N.scaleX=t}get scaleX(){return this.#N.scaleX}set scaleY(t){this.#N.scaleY=t}get scaleY(){return this.#N.scaleY}set pivotX(t){this.#N.pivotX=t}get pivotX(){return this.#N.pivotX}set pivotY(t){this.#N.pivotY=t}get pivotY(){return this.#N.pivotY}set rotation(t){this.#N.rotation=t}get rotation(){return this.#N.rotation}set layer(t){this.#L!==t&&(this.#L=t,void 0!==this.id&&this.stateTree&&this.stateTree.setLayer(this.id,t))}get layer(){return this.#L}set tint(t){this.#M!==t&&(this.#M=t,void 0!==this.id&&this.stateTree&&this.stateTree.setTint(this.id,t+1))}get tint(){return this.#M}set drawOrder(t){this.#D!==t&&(this.#D=t,this.#k=!0,void 0!==this.id&&this.stateTree&&this.stateTree.setDrawOrder(this.id,t))}get drawOrder(){return this.#D??0}}class Xt extends Rt{constructor(t,e){super(),this.id=0,this.stateTree=t,this.messageBridge=e,t.setWorldX(0,0),t.setWorldY(0,0),t.setWorldScaleX(0,1),t.setWorldScaleY(0,1),t.setWorldRotation(0,0),t.setWorldCos(0,1),t.setWorldSin(0,0),t.setWorldAlpha(0,1)}}class xt extends Rt{type=gt.AnimatedSprite;#G;#V;constructor(t){super(t),this.#G=t.asset,this.#V=t.animation}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setAssetId(i,this.#G),e.setAnimationId(i,this.#V),i}set animation(t){this.#V!==t&&(this.#V=t,void 0!==this.id&&this.stateTree&&this.stateTree.setAnimationId(this.id,t)),this.id&&this.messageBridge?.sendAnimationChangedToRenderWorker(this.id,t)}get animation(){return this.#V}}class Ot extends Rt{type=gt.BitmapText;#q;#j;constructor(t){super(t),this.#q=t.asset,this.#j=t.text}get asset(){return this.#q}set asset(t){this.#q!==t&&(this.#q=t,void 0!==this.id&&this.stateTree&&this.stateTree.setAssetId(this.id,t))}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setAssetId(i,this.#q),s.sendTextToRenderWorker(i,this.#j),i}}class It extends Rt{type=gt.Circle;#$;#z;constructor(t){super(t),this.#$=t.shape,this.#z=t.radius}get radius(){return this.#z}set radius(t){this.#z!==t&&(this.#z=t,void 0!==this.id&&this.stateTree&&this.stateTree.setRadius(this.id,t))}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setShapeId(i,this.#$),e.setRadius(i,this.#z),i}}class Et extends mt{#J;#K=0;#Q;constructor(t,e){super(),this.#J=t,this.#Q=e}update(t){this.paused||(super.update(t),this.#K+=t,this.#K>=this.#J&&(this.#Q(),this.remove()))}}class Ft extends mt{interval;#K=0;#Q;constructor(t,e){super(),this.interval=t,this.#Q=e}update(t){this.paused||(super.update(t),this.#K+=t,this.#K>=this.interval&&(this.#K%=this.interval,this.#Q()))}}class Yt extends Rt{type=gt.Rectangle;#$;#Z;#tt;constructor(t){super(t),this.#$=t.shape,this.#Z=t.width,this.#tt=t.height}get width(){return this.#Z}set width(t){this.#Z!==t&&(this.#Z=t,void 0!==this.id&&this.stateTree&&this.stateTree.setWidth(this.id,t))}get height(){return this.#tt}set height(t){this.#tt!==t&&(this.#tt=t,void 0!==this.id&&this.stateTree&&this.stateTree.setHeight(this.id,t))}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setShapeId(i,this.#$),e.setWidth(i,this.#Z),e.setHeight(i,this.#tt),i}}class Ht extends Rt{type=gt.PhysicsObject;#et;#st;#it;constructor(t){super(t),this.#et=t.body,this.#st=t.velocityX??0,this.#it=t.velocityY??0}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setBodyId(i,this.#et),e.setVelocityX(i,this.#st),e.setVelocityY(i,this.#it),i}set body(t){this.#et!==t&&(this.#et=t,void 0!==this.id&&this.stateTree&&this.stateTree.setBodyId(this.id,t))}get body(){return this.#et}set velocityX(t){this.#st!==t&&(this.#st=t,void 0!==this.id&&this.stateTree&&this.stateTree.setVelocityX(this.id,t))}get velocityX(){return this.#st}set velocityY(t){this.#it!==t&&(this.#it=t,void 0!==this.id&&this.stateTree&&this.stateTree.setVelocityY(this.id,t))}get velocityY(){return this.#it}}class wt extends Rt{type=gt.PhysicsWorld;#rt;constructor(t){super(t),this.#rt=t.world}attachToStateTree(t,e,s){const i=super.attachToStateTree(t,e,s);return e.setWorldId(i,this.#rt),i}}class bt{#at;constructor(t){this.#at=t}sendTextToRenderWorker(t,e){this.#at.postMessage({type:"text",id:t,text:e})}sendAnimationChangedToRenderWorker(t,e){this.#at.postMessage({type:"animationChanged",id:t,animation:e})}}var Ct,Pt,At,Bt;!function(t){t[t.SPRITE_HERO=0]="SPRITE_HERO",t[t.SPRITE_ORC=1]="SPRITE_ORC",t[t.SPRITE_POTION=2]="SPRITE_POTION",t[t.FONT_WHITE_PEABERRY=3]="FONT_WHITE_PEABERRY",t[t.BGM_BATTLE=4]="BGM_BATTLE",t[t.SFX_HERO_HIT_1=5]="SFX_HERO_HIT_1",t[t.SFX_HERO_HIT_2=6]="SFX_HERO_HIT_2",t[t.SFX_HERO_HIT_3=7]="SFX_HERO_HIT_3",t[t.SFX_HERO_MISS_1=8]="SFX_HERO_MISS_1",t[t.SFX_HERO_MISS_2=9]="SFX_HERO_MISS_2",t[t.SFX_HERO_MISS_3=10]="SFX_HERO_MISS_3",t[t.SFX_HERO_HEAL=11]="SFX_HERO_HEAL",t[t.SFX_HERO_DIE=12]="SFX_HERO_DIE",t[t.SFX_ORC_HIT_1=13]="SFX_ORC_HIT_1",t[t.SFX_ORC_HIT_2=14]="SFX_ORC_HIT_2",t[t.SFX_ORC_HIT_3=15]="SFX_ORC_HIT_3",t[t.SFX_ORC_MISS_1=16]="SFX_ORC_MISS_1",t[t.SFX_ORC_MISS_2=17]="SFX_ORC_MISS_2",t[t.SFX_ORC_MISS_3=18]="SFX_ORC_MISS_3",t[t.SFX_ORC_DIE=19]="SFX_ORC_DIE"}(Ct||(Ct={})),Ct.SPRITE_HERO,Ct.SPRITE_ORC,Ct.SPRITE_POTION,Ct.FONT_WHITE_PEABERRY,Ct.BGM_BATTLE,Ct.SFX_HERO_HIT_1,Ct.SFX_HERO_HIT_2,Ct.SFX_HERO_HIT_3,Ct.SFX_HERO_MISS_1,Ct.SFX_HERO_MISS_2,Ct.SFX_HERO_MISS_3,Ct.SFX_HERO_HEAL,Ct.SFX_HERO_DIE,Ct.SFX_ORC_HIT_1,Ct.SFX_ORC_HIT_2,Ct.SFX_ORC_HIT_3,Ct.SFX_ORC_MISS_1,Ct.SFX_ORC_MISS_2,Ct.SFX_ORC_MISS_3,Ct.SFX_ORC_DIE,function(t){t[t.Stage=0]="Stage"}(Pt||(Pt={})),Pt.Stage,function(t){t[t.Idle=0]="Idle",t[t.Attack1=1]="Attack1",t[t.Attack2=2]="Attack2",t[t.Die=3]="Die",t[t.Animation=4]="Animation"}(At||(At={})),At.Idle,At.Attack1,At.Attack2,At.Die,At.Animation,function(t){t[t.HERO_BODY=0]="HERO_BODY",t[t.ORC_BODY=1]="ORC_BODY"}(Bt||(Bt={}));const Nt={[Bt.HERO_BODY]:{rigidbody:{type:ft.Rectangle,width:30,height:30},fixedRotation:!0,isStatic:!0},[Bt.ORC_BODY]:{rigidbody:{type:ft.Rectangle,width:30,height:30},fixedRotation:!0}};var Lt,Mt;!function(t){t[t.HUD=0]="HUD"}(Lt||(Lt={})),function(t){t[t.HP_BAR_BG=0]="HP_BAR_BG",t[t.HP_BAR_FG=1]="HP_BAR_FG",t[t.DEBUG_CHAR_BODY=2]="DEBUG_CHAR_BODY",t[t.DEBUG_CHAR_HITBOX=3]="DEBUG_CHAR_HITBOX",t[t.DEBUG_CHAR_HURTBOX=4]="DEBUG_CHAR_HURTBOX",t[t.DEBUG_POTION_TRIGGER=5]="DEBUG_POTION_TRIGGER"}(Mt||(Mt={})),Mt.HP_BAR_BG,Mt.HP_BAR_FG,Mt.DEBUG_CHAR_BODY,Mt.DEBUG_CHAR_HITBOX,Mt.DEBUG_CHAR_HURTBOX,Mt.DEBUG_POTION_TRIGGER;class Dt extends Ot{#it=-50;#ot=100;#ht=1;#nt=0;#ct=.5;#lt=1;#dt=1.2;constructor(t){super({...t,asset:Ct.FONT_WHITE_PEABERRY,text:`-${t.damage}`})}update(t){if(this.paused)return;super.update(t),this.#nt+=t,this.#it+=this.#ot*t,this.y+=this.#it*t;const e=Math.min(this.#nt/this.#ht,1),s=this.#lt+(this.#dt-this.#lt)*e;if(this.scale=s,this.#nt>this.#ct){const t=(this.#nt-this.#ct)/(this.#ht-this.#ct);this.alpha=Math.max(1-t,0)}this.#nt>=this.#ht&&this.remove()}}class kt extends Ot{#it=-50;#ot=100;#ht=1;#nt=0;#ct=.5;#lt=1;#dt=1.2;constructor(t){super({...t,asset:Ct.FONT_WHITE_PEABERRY,text:`+${t.hp}`})}update(t){if(this.paused)return;super.update(t),this.#nt+=t,this.#it+=this.#ot*t,this.y+=this.#it*t;const e=Math.min(this.#nt/this.#ht,1),s=this.#lt+(this.#dt-this.#lt)*e;if(this.scale=s,this.#nt>this.#ct){const t=(this.#nt-this.#ct)/(this.#ht-this.#ct);this.alpha=Math.max(1-t,0)}this.#nt>=this.#ht&&this.remove()}}class Ut extends Rt{#ut=new Yt({shape:Mt.HP_BAR_BG,alpha:.4,width:26,height:4});#pt=new Yt({shape:Mt.HP_BAR_FG,width:26,height:4});#gt;#ft;constructor(t){super(t),this.#gt=t.maxHp,this.#ft=t.hp,this.add(this.#ut,this.#pt),this.#yt()}#yt(){const t=26*Math.max(0,Math.min(1,this.#ft/this.#gt));this.#pt.width=t,this.#pt.x=-(26-t)/2}set hp(t){this.#ft=t,this.#yt()}get hp(){return this.#ft}}class Wt extends Ht{maxHp;hp;dead=!1;hitbox;hurtbox;#_t;_sprite;#mt;#Tt;constructor(t){if(super({...t,useYSort:!0}),this.maxHp=t.maxHp,this.hp=t.hp,this.hitbox=t.hitbox,this.hurtbox=t.hurtbox,this.#_t=new Ut({y:-30,maxHp:t.maxHp,hp:t.hp,layer:Lt.HUD}),this.add(this.#_t),rt){const e=Nt[t.body].rigidbody;this.add(new Yt({shape:Mt.DEBUG_CHAR_BODY,...e,alpha:.5,layer:Lt.HUD})),this.#mt=new Yt({shape:Mt.DEBUG_CHAR_HITBOX,...this.hitbox,alpha:.5,layer:Lt.HUD}),this.add(this.#mt),this.add(new Yt({shape:Mt.DEBUG_CHAR_HURTBOX,...this.hurtbox,alpha:.5,layer:Lt.HUD}))}}set hitboxX(t){this.hitbox.x=t,this.#mt&&(this.#mt.x=t)}takeDamage(t){this.dead||(this.hp-=t,this.#_t.hp=this.hp,this._sprite&&(this._sprite.tint=16711680,this.#Tt?.remove(),this.#Tt=new Et(.1,()=>this._sprite.tint=16777215),this.add(this.#Tt)),this.emit("changeHp",t),this.add(new Dt({y:-20,damage:t,layer:Lt.HUD})),this.hp<=0&&(this.dead=!0,this.onDie(),this.emit("dead")))}heal(t){this.dead||(this.hp=Math.min(this.maxHp,this.hp+t),this.#_t.hp=this.hp,this._sprite&&(this._sprite.tint=65280,this.#Tt?.remove(),this.#Tt=new Et(.1,()=>this._sprite.tint=16777215),this.add(this.#Tt)),this.emit("changeHp",t),this.add(new kt({y:-20,hp:t,layer:Lt.HUD})))}}class Gt extends Wt{_sprite;#St=0;#vt=0;#Rt=this.x;#Xt=!1;constructor(t){super({...t,maxHp:1e4,hp:1e4,body:Bt.HERO_BODY,hitbox:{type:s.Rectangle,width:32,height:52,x:24,y:-8},hurtbox:{type:s.Rectangle,width:24,height:40,x:0,y:-4}}),this._sprite=new xt({asset:Ct.SPRITE_HERO,animation:At.Idle,scale:2}),this.add(this._sprite)}move(t,e){this.dead||(this.#St=Math.cos(t)*e*200,this.#vt=Math.sin(t)*e*200)}stop(){this.#St=0,this.#vt=0}attack(){this.dead||this.#Xt||(this.#Xt=!0,this._sprite.animation=Math.floor(2*Math.random())?At.Attack1:At.Attack2,this.add(new Et(.3,()=>this.emit("hit",60))),e.playRandom(Ct.SFX_HERO_MISS_1,Ct.SFX_HERO_MISS_2,Ct.SFX_HERO_MISS_3),this.add(new Et(.5,()=>{this.#Xt=!1,this._sprite.animation=At.Idle})))}update(t){if(!this.paused){if(super.update(t),this.x+=this.#St*t,this.y+=this.#vt*t,this._sprite&&this.x!==this.#Rt){const t=Math.abs(this._sprite.scaleX);this._sprite.scaleX=this.x>this.#Rt?t:-t,this.hitboxX=this.x>this.#Rt?24:-24}this.#Rt=this.x}}takeDamage(t){super.takeDamage(t),e.playRandom(Ct.SFX_HERO_HIT_1,Ct.SFX_HERO_HIT_2,Ct.SFX_HERO_HIT_3)}heal(t){super.heal(t),e.play(Ct.SFX_HERO_HEAL)}onDie(){this._sprite.animation=At.Die,this.#St=0,this.#vt=0,this.body=it,e.play(Ct.SFX_HERO_DIE),this.add(new Et(.5,()=>this.emit("dead")))}}class Vt extends Wt{_sprite;#St=0;#vt=0;#Xt=!1;constructor(t){super({...t,maxHp:100,hp:100,body:Bt.ORC_BODY,hitbox:{type:s.Rectangle,width:32,height:52,x:24,y:-8},hurtbox:{type:s.Rectangle,width:24,height:32,x:0,y:0}}),this._sprite=new xt({asset:Ct.SPRITE_ORC,animation:At.Idle,scale:2}),this.add(this._sprite)}moveTo(t,e){if(this.dead)return;const s=t-this.x,i=e-this.y,r=Math.atan2(i,s);this.#St=3*Math.cos(r),this.#vt=3*Math.sin(r);const a=Math.abs(this._sprite.scaleX);this._sprite.scaleX=s>0?a:-a,this.hitboxX=s>0?24:-24}stop(){this.#St=0,this.#vt=0}attack(){this.dead||this.#Xt||(this.#Xt=!0,this.#St=0,this.#vt=0,this._sprite.animation=Math.floor(2*Math.random())?At.Attack1:At.Attack2,this.add(new Et(.3,()=>this.emit("hit",1))),e.playRandom(Ct.SFX_ORC_MISS_1,Ct.SFX_ORC_MISS_2,Ct.SFX_ORC_MISS_3),this.add(new Et(.5,()=>{this.#Xt=!1,this.dead||(this._sprite.animation=At.Idle)})))}update(t){this.paused||(super.update(t),this.velocityX=this.#St,this.velocityY=this.#vt)}takeDamage(t){super.takeDamage(t),e.playRandom(Ct.SFX_ORC_HIT_1,Ct.SFX_ORC_HIT_2,Ct.SFX_ORC_HIT_3)}onDie(){this._sprite.animation=At.Die,this.#St=0,this.#vt=0,this.body=it,e.play(Ct.SFX_ORC_DIE),this.add(new Et(.5,()=>this.emit("dead")))}}class qt extends Rt{triggerCollider={type:s.Circle,radius:16};healAmount;constructor(t){super({...t,useYSort:!0}),this.healAmount=t?.healAmount??100,this.add(new xt({asset:Ct.SPRITE_POTION,animation:At.Animation,scale:2})),rt&&this.add(new It({shape:Mt.DEBUG_POTION_TRIGGER,...this.triggerCollider,alpha:.5,layer:Lt.HUD}))}}class jt extends wt{#xt=new Gt;#Ot=new Set;#It=new Set;#Et=0;#Ft=!1;#Yt;#Ht;constructor(){super({world:Pt.Stage}),t.play(Ct.BGM_BATTLE),this.add(this.#xt),this.add(this.#Yt=new Ft(1,()=>this.#wt())),this.add(this.#Ht=new Ft(3,()=>this.#bt()));for(let t=0;t<1e3;t++)this.#wt();this.#xt.on("hit",t=>{for(const e of this.#Ot)st(this.#xt.hitbox,this.#xt.worldTransform,e.hurtbox,e.worldTransform)&&e.takeDamage(t)}),this.#xt.on("dead",()=>{this.#Ct()})}#Ct(){this.#Ft=!0,this.#Yt.remove(),this.#Ht.remove();for(const t of this.#Ot)t.stop()}#wt(){const t=new Vt;t.x=800*Math.random()-400,t.y=600*Math.random()-300,t.on("hit",e=>{st(this.#xt.hurtbox,this.#xt.worldTransform,t.hitbox,t.worldTransform)&&(this.#xt.takeDamage(e),this.emit("changeHp",this.#xt.hp))}),this.add(t),this.#Ot.add(t),t.on("dead",()=>{this.#Ot.delete(t),this.#Et+=100,this.emit("changeScore",this.#Et)})}#bt(){const t=new qt;t.x=800*Math.random()-400,t.y=600*Math.random()-300,this.add(t),this.#It.add(t),t.on("remove",()=>this.#It.delete(t))}update(t){if(this.paused)return;if(super.update(t),this.#Ft)return;const e=this.#xt;if(!e.dead){for(const t of this.#Ot)st(e.hurtbox,e.worldTransform,t.hitbox,t.worldTransform)?t.attack():t.moveTo(this.#xt.x,this.#xt.y);for(const t of this.#It)st(e.hitbox,e.worldTransform,t.triggerCollider,t.worldTransform)&&(e.heal(t.healAmount),t.remove())}}heroMove(t,e){this.#xt.move(t,e)}heroRelease(){this.#xt.stop()}heroAttack(){this.#xt.attack()}}let $t,zt;rt=!0;let Jt=0;onmessage=t=>{const e=t.data.type;"init"===e&&function(t,e){const s=new pt(t),i=new bt(e),r=new Xt(s,i);zt=new jt,zt.on("changeHp",t=>postMessage({type:"changeHp",hp:t})),zt.on("changeScore",t=>postMessage({type:"changeScore",score:t})),r.add(zt),$t=new yt(t=>{Jt=1/t,r.update(t)}),rt&&setInterval(()=>{postMessage({type:"fps",value:Jt})},1e3)}(t.data.sab,t.data.port),"setFpsCap"===e&&$t.setFpsCap(t.data.fps),"heroMove"===e&&zt.heroMove(t.data.r,t.data.d),"heroRelease"===e&&zt.heroRelease(),"heroAttack"===e&&zt.heroAttack()}})();